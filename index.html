<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø§ÙˆØ¨Ø± Ø¢Ø´ÙˆØ¨</title>

    <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" type="text/css" />

    <style>
        body {
            font-family: "Segoe UI", Tahoma, sans-serif;
            background-color: #0f172a; 
            color: #e0f2fe; 
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        /* UI Ø§ØµÙ„ÛŒ Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ Ù…Ø®ÙÛŒ Ø§Ø³Øª */
        h1, #toggle-layout-btn, #help-text, #visualization {
            display: none;
        }

        h1 {
            position: absolute;
            top: 10px;
            right: 20px;
            z-index: 10;
            color: #4fc3f7; 
            opacity: 0.8;
            font-size: 1.5em;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        #visualization {
            width: 100vw;
            height: 100vh;
            background-color: #1e293b;
            background-image: radial-gradient(circle, #2a3a50 0%, #1e293b 70%);
        }

        #toggle-layout-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background-color: #4fc3f7; 
            color: #0f172a; 
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: "Segoe UI", Tahoma, sans-serif;
            font-weight: bold;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #toggle-layout-btn:hover {
            background-color: #81d4fa; 
        }

        #help-text {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            color: #fff;
            background-color: rgba(30, 41, 59, 0.5); 
            backdrop-filter: blur(5px);
            padding: 5px 15px;
            border-radius: 5px;
            border: 1px solid rgba(227, 242, 253, 0.1);
        }
        
        /* --- CSS Ù¾Ø§Ù¾â€ŒØ¢Ù¾ (Modal) --- */
        .modal-backdrop {
            display: none;
            position: fixed;
            z-index: 99;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); 
        }
        
        /* Ù…ÙˆØ¯Ø§Ù„ Ø§ØµÙ„ÛŒ (ÙˆÛŒØ±Ø§ÛŒØ´ Ú¯Ø±Ù‡) */
        #custom-modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 90%; 
            max-width: 450px; 
            max-height: 85vh; 
            display: flex;
            flex-direction: column;
            background-color: rgba(179, 229, 252, 0.15); 
            backdrop-filter: blur(15px); 
            border: 1px solid rgba(227, 242, 253, 0.2); 
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        #modal-header {
            padding: 15px 20px;
            font-size: 1.2em;
            font-weight: bold;
            background-color: rgba(179, 229, 252, 0.1); 
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            color: #e0f2fe;
            border-bottom: 1px solid rgba(227, 242, 253, 0.1);
        }
        
        #modal-body {
            padding: 20px;
            overflow-y: auto; 
        }

        #choice-buttons {
            display: none; 
            text-align: center;
        }
        #choice-buttons p {
             color: #b3e5fc; 
        }
        #choice-buttons button {
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            border-radius: 8px; 
            border: none;
            font-family: "Segoe UI", Tahoma, sans-serif;
            font-weight: bold;
            width: 100%; 
            box-sizing: border-box; 
            margin: 10px 0;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        #choice-add-btn { background-color: #4fc3f7; color: #0f172a; } 
        #choice-edit-btn { background-color: #b3e5fc; color: #0f172a; } 

        #choice-add-btn:hover { background-color: #81d4fa; }
        #choice-edit-btn:hover { background-color: #e1f5fe; }

        #node-form { display: none; }
        #node-form .form-group { margin-bottom: 15px; }
        #node-form label { display: block; margin-bottom: 5px; font-weight: bold; color: #b3e5fc; }
        
        #node-form input[type="text"],
        #node-form input[type="date"],
        #node-form textarea { 
            width: 100%; 
            box-sizing: border-box; 
            padding: 10px; 
            border-radius: 8px; 
            border: 1px solid rgba(227, 242, 253, 0.2); 
            background-color: rgba(15, 23, 42, 0.5); 
            color: #e0f2fe; 
            font-family: "Segoe UI", Tahoma, sans-serif; 
            font-size: 1em; 
            transition: all 0.2s ease;
        }
        
        #node-form ::placeholder {
            color: #64748b; 
            opacity: 0.8;
        }

        #node-form input[type="text"]:focus,
        #node-form input[type="date"]:focus,
        #node-form textarea:focus { 
            border-color: #4fc3f7; 
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.5);
            outline: none;
        }

        #node-form textarea { resize: vertical; min-height: 60px; }
        #node-form input[type="range"] { width: 100%; box-sizing: border-box; }
        #node-form small { font-size: 0.8em; color: #94a3b8; margin-top: 5px; display: block; } 
        #node-form input:disabled,
        #node-form textarea:disabled { background-color: #1e293b; opacity: 0.5; cursor: not-allowed; }

        #modal-footer {
            padding: 15px 20px;
            background-color: rgba(179, 229, 252, 0.1); 
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap-reverse; 
            gap: 10px; 
            border-top: 1px solid rgba(227, 242, 253, 0.1);
        }
        
        #modal-footer button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: "Segoe UI", Tahoma, sans-serif;
            font-weight: bold;
            flex-grow: 1; 
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        
        #action-buttons {
             display: none;
             flex-grow: 1; 
             display: flex;
             gap: 10px;
        }
        #action-buttons button { margin-right: 0; }
        
        #modal-footer > div:last-child {
            flex-grow: 1; 
            display: flex;
            gap: 10px;
        }

        #modal-save-btn { background-color: #4fc3f7; color: #0f172a; } 
        #modal-close-btn { background-color: #64748b; color: #ffffff; } 
        #happened-btn { background-color: #2dd4bf; color: #0f172a; } 
        #not-happened-btn { background-color: #f43f5e; color: white; } 
        #delete-btn { background-color: #e11d48; color: white; } 

        #modal-save-btn:hover { background-color: #81d4fa; }
        #modal-close-btn:hover { background-color: #7f8fa6; }
        #happened-btn:hover { filter: brightness(1.1); }
        #not-happened-btn:hover { filter: brightness(1.1); }
        #delete-btn:hover { filter: brightness(1.1); }

        /* --- Ù…ÙˆØ¯Ø§Ù„ Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ (Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù‚Ø´Ù‡) --- */
        #welcome-modal {
            display: none;
            position: fixed;
            z-index: 101; 
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 90%; 
            max-width: 450px; 
            background-color: rgba(179, 229, 252, 0.15); 
            backdrop-filter: blur(15px); 
            border: 1px solid rgba(227, 242, 253, 0.2); 
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            padding: 20px;
            box-sizing: border-box;
        }
        #welcome-modal h2 {
            margin-top: 0;
            color: #e0f2fe;
            text-align: center;
        }
        #welcome-modal button {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            font-family: "Segoe UI", Tahoma, sans-serif;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        
        /* ØªØºÛŒÛŒØ± Û±: Ø§Ø³ØªØ§ÛŒÙ„ ÙÛŒÙ„Ø¯ Ù†Ø§Ù… Ù†Ù‚Ø´Ù‡ Ø¬Ø¯ÛŒØ¯ */
        #welcome-new-map-name {
            width: 100%; 
            box-sizing: border-box; 
            padding: 10px; 
            border-radius: 8px; 
            border: 1px solid rgba(227, 242, 253, 0.2); 
            background-color: rgba(15, 23, 42, 0.5); 
            color: #e0f2fe; 
            font-family: "Segoe UI", Tahoma, sans-serif; 
            font-size: 1em; 
            transition: all 0.2s ease;
            margin-bottom: 15px; /* ÙØ§ØµÙ„Ù‡ Ø§Ø² Ø¯Ú©Ù…Ù‡ */
        }
         #welcome-new-map-name::placeholder {
            color: #64748b; 
            opacity: 0.8;
        }
         #welcome-new-map-name:focus {
            border-color: #4fc3f7; 
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.5);
            outline: none;
        }

        #welcome-create-btn {
            background-color: #4fc3f7;
            color: #0f172a;
            /* margin-bottom: 15px; */ /* Ø­Ø°Ù Ø´Ø¯ Ú†ÙˆÙ† ÙÛŒÙ„Ø¯ Ù†Ø§Ù… Ø²ÛŒØ±Ø´ Ù‡Ø³Øª */
        }
        #welcome-create-btn:hover {
            background-color: #81d4fa;
        }
        
        #welcome-load-section {
            border-top: 1px solid rgba(227, 242, 253, 0.2);
            padding-top: 15px;
            margin-top: 15px;
        }
        #welcome-load-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #b3e5fc;
        }
        #welcome-map-selector {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(227, 242, 253, 0.2);
            background-color: rgba(15, 23, 42, 0.5);
            color: #e0f2fe;
            font-family: "Segoe UI", Tahoma, sans-serif;
            font-size: 1em;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        #welcome-load-btn {
            background-color: #b3e5fc;
            color: #0f172a;
        }
        #welcome-load-btn:hover {
            background-color: #e1f5fe;
        }

        /* --- Ù…ÙˆØ¯Ø§Ù„ Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø²Ø¯ÛŒØ¯ (Ø¹Ú©Ø³) --- */
        #first-visit-modal {
            display: none;
            position: fixed;
            z-index: 103; 
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 90%; 
            max-width: 500px; 
            background-color: rgba(179, 229, 252, 0.15); 
            backdrop-filter: blur(15px); 
            border: 1px solid rgba(227, 242, 253, 0.2); 
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            padding: 15px; 
            box-sizing: border-box;
            text-align: center;
        }
        #first-visit-modal img {
            width: 100%;
            max-width: 400px; 
            height: auto;
            border-radius: 8px;
            margin-bottom: 15px; 
            border: 1px solid rgba(227, 242, 253, 0.1);
        }
        #first-visit-continue-btn {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            font-family: "Segoe UI", Tahoma, sans-serif;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            background-color: #4fc3f7;
            color: #0f172a;
        }
        #first-visit-continue-btn:hover {
            background-color: #81d4fa;
        }


        /* --- Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ --- */
        @media (max-width: 600px) {
            h1 {
                font-size: 1.2em;
                top: 15px;
                right: 15px;
            }
            #toggle-layout-btn {
                top: 15px;
                left: 15px;
                padding: 8px 12px;
                font-size: 0.8em;
            }
            #help-text {
                font-size: 0.8em;
                bottom: 10px;
                width: 90%;
                text-align: center;
            }
            #modal-body {
                padding: 15px;
            }
            #modal-footer {
                flex-direction: column-reverse; 
                align-items: stretch; 
            }
            #modal-footer > div,
            #action-buttons {
                width: 100%;
                justify-content: center;
            }
            #modal-footer > div:last-child {
                 justify-content: space-between;
            }
        }

    </style>
</head>
<body>

    <h1>ğŸ§­ Ù†Ø§ÙˆØ¨Ø± Ø¢Ø´ÙˆØ¨</h1>
    
    <button id="toggle-layout-btn">ØªØºÛŒÛŒØ± Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§Ø±Ú¯Ø§Ù†ÛŒÚ©</button>

    <div id="help-text">
        Ø±ÙˆÛŒ Ú¯Ø±Ù‡â€ŒÙ‡Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯...
    </div>

    <div id="visualization"></div>

    <div id="modal-backdrop" class="modal-backdrop"></div>
    <div id="custom-modal">
        <div id="modal-header">...</div>
        <div id="modal-body">
            
            <div id="choice-buttons">
                    <p>Ú†Ù‡ Ú©Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯ØŸ</p>
                    <button id="choice-add-btn">â• Ø§ÙØ²ÙˆØ¯Ù† Ø§Ù†Ø´Ø¹Ø§Ø¨ Ø¬Ø¯ÛŒØ¯</button>
                    <button id="choice-edit-btn">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ / Ù‡Ø±Ø³ / Ø­Ø°Ù</button>
            </div>

            <form id="node-form">
                <div class="form-group">
                    <label for="node-title">Ø¹Ù†ÙˆØ§Ù†:</label>
                    <input type="text" id="node-title" placeholder="Ù…Ø«Ø§Ù„: Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡ X">
                </div>
                <div class="form-group">
                    <label for="node-desc">ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
                    <textarea id="node-desc" placeholder="Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ± Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø§ÛŒÙ† Ø§Ø­ØªÙ…Ø§Ù„..."></textarea>
                </div>
                <div class="form-group">
                    <label for="node-action">Ø§Ù‚Ø¯Ø§Ù…:</label>
                    <textarea id="node-action" placeholder="Ø§Ú¯Ø± Ø§ÛŒÙ† Ø§ØªÙØ§Ù‚ Ø§ÙØªØ§Ø¯ Ú†Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ"></textarea>
                </div>
                <div class="form-group">
                    <label for="node-probability">Ø§Ø­ØªÙ…Ø§Ù„ (0-10):</label>
                    <input type="range" id="node-probability" min="0" max="10" value="5">
                    <small>Ø§Ù…ØªÛŒØ§Ø² Ø¨ÛŒÙ† 0 ØªØ§ 10 Ø¨Ø¯Ù‡ÛŒØ¯.</small>
                </div>
                <div class="form-group">
                    <label for="node-anxiety">Ø§Ø¶Ø·Ø±Ø§Ø¨ (0-100):</label>
                    <input type="range" id="node-anxiety" min="0" max="100" value="50">
                    <small>Ù…ÛŒØ²Ø§Ù† Ù†Ú¯Ø±Ø§Ù†ÛŒ Ø§Ø² ÙˆÙ‚ÙˆØ¹ (0 Ú©Ù…ØŒ 100 Ø²ÛŒØ§Ø¯)</small> 
                </div>
                <div class="form-group">
                    <label for="node-dueDate">ØªØ§Ø±ÛŒØ® Ú©Ù„ÛŒØ¯ÛŒ:</label>
                    <input type="date" id="node-dueDate" placeholder="ØªØ§Ø±ÛŒØ®ÛŒ Ú©Ù‡ Ù†ØªÛŒØ¬Ù‡ Ù…Ø´Ø®Øµ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
                </div>
            </form>

        </div>
        <div id="modal-footer">
            <div id="action-buttons"><button id="happened-btn">âœ…</button><button id="not-happened-btn">âŒ</button><button id="delete-btn">ğŸ—‘ï¸</button></div>
            <div><button id="modal-save-btn">Ø°Ø®ÛŒØ±Ù‡</button><button id="modal-close-btn">Ø¨Ø³ØªÙ†</button></div>
        </div>
    </div>

    <div id="welcome-modal-backdrop" class="modal-backdrop"></div>
    <div id="welcome-modal">
        <h2>ğŸ§­ Ø¨Ù‡ Ù†Ø§ÙˆØ¨Ø± Ø¢Ø´ÙˆØ¨ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
        
        <input type="text" id="welcome-new-map-name" placeholder="Ù†Ø§Ù… Ù†Ù‚Ø´Ù‡ Ø¬Ø¯ÛŒØ¯...">
        <button id="welcome-create-btn">â• Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù‚Ø´Ù‡ Ø¬Ø¯ÛŒØ¯</button>
        
        <div id="welcome-load-section">
            <label for="welcome-map-selector">ÛŒØ§ ÛŒÚ© Ù†Ù‚Ø´Ù‡ Ù‚Ø¨Ù„ÛŒ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯:</label>
            <select id="welcome-map-selector"></select>
            <button id="welcome-load-btn">ğŸ“‚ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ù‚Ø´Ù‡</button>
        </div>
    </div>

    <div id="first-visit-backdrop" class="modal-backdrop"></div>
    <div id="first-visit-modal">
        <img src="welcome-image.png" alt="Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯">
        <button id="first-visit-continue-btn">Ø§Ø¯Ø§Ù…Ù‡</button>
    </div>


    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <script type="text/javascript">
        
        // --- ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ (Ø³Ø§ÛŒØ²) ---
        function getNodeSizeProps(probability) {
            const prob = Math.max(parseFloat(probability) || 0, 0);
            const size = 15 + prob; 
            return {
                size: size,
                widthConstraint: size * 2,
                heightConstraint: size * 2
            };
        }

        // --- Ø§Ù„Ù: ØªØ¹Ø±ÛŒÙ Ø¯ÛŒØªØ§Ø¨ÛŒØ³â€ŒÙ‡Ø§ ---
        var nodes = new vis.DataSet();
        var edges = new vis.DataSet();
        var data = { nodes: nodes, edges: edges };
        var nodeDataStore = {};

        let allMapsData = {}; 
        let currentMapId = null;
        const defaultMapId = 'map_default';

        const rootId = 1;
        const rootData = { 
            id: rootId, 
            title: 'Ù…ÙˆØ¶ÙˆØ¹ Ø§ØµÙ„ÛŒ', 
            description: 'Ø±ÙˆÛŒ Ù…Ù† Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯...', 
            actionPlan: '', 
            probability: 10, 
            cumulativeProbability: 10, 
            anxiety: 0, 
            dueDate: '', 
            pruned: false, 
        };
        nodeDataStore[rootId] = rootData;
        
        nodes.add({ 
            id: rootId, 
            label: rootData.title, 
            shape: 'circle', 
            ...getNodeSizeProps(rootData.cumulativeProbability), 
            color: { background: '#4fc3f7', border: '#81d4fa' }, 
            font: { color: 'white', size: 14, multi: false } 
        });
        
        const prunedColor = { background: '#1e293b', border: '#334155', highlight: { background: '#1e293b', border: '#334155' } };
        const prunedFont = { color: '#475569' };

        // --- Ø¨ØŒ Ø¬ØŒ Ø¯: ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø±Ø§Ù ---
        const baseOptions = { 
            nodes: { 
                shape: 'circle', 
                ...getNodeSizeProps(5), 
                scaling: { label: { enabled: false } }, 
                color: { 
                    background: '#334155', 
                    border: '#475569', 
                    highlight: { background: '#475569', border: '#4fc3f7' } 
                }, 
                font: { color: '#e0f2fe', size: 14, multi: false }, 
            }, 
            interaction: { dragNodes: true, dragView: true, zoomView: true } 
        };
        const hierarchicalOptions = { 
            ...baseOptions, 
            layout: { hierarchical: { enabled: true, direction: 'RL', sortMethod: 'directed', nodeSpacing: 150, treeSpacing: 250 } }, 
            edges: { 
                smooth: { type: 'cubicBezier', forceDirection: 'horizontal', roundness: 0.7 }, 
                arrows: { to: { enabled: true, scaleFactor: 0.5 } }, 
                color: { color: '#475569', highlight: '#4fc3f7' } 
            }, 
            physics: false 
        };
        const physicsOptions = { 
            ...baseOptions, 
            layout: { hierarchical: { enabled: false } }, 
            edges: { 
                smooth: { type: 'dynamic' }, 
                arrows: { to: { enabled: true, scaleFactor: 0.5 } }, 
                color: { color: '#475569', highlight: '#4fc3f7' } 
            }, 
            physics: { enabled: true, solver: 'barnesHut', barnesHut: { gravitationalConstant: -8000, centralGravity: 0.1, springLength: 150, avoidOverlap: 0.5 } } 
        };
        
        var container = document.getElementById('visualization');
        let isHierarchical = true;
        var network = new vis.Network(container, data, hierarchicalOptions);
        const toggleBtn = document.getElementById('toggle-layout-btn');
        toggleBtn.addEventListener('click', function() {
             isHierarchical = !isHierarchical;
             if (isHierarchical) {
                 nodes.update({ id: rootId, fixed: false });
                 network.setOptions(hierarchicalOptions);
                 toggleBtn.innerText = 'ØªØºÛŒÛŒØ± Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§Ø±Ú¯Ø§Ù†ÛŒÚ©';
             } else {
                 nodes.update({ id: rootId, fixed: true, x: 0, y: 0 });
                 network.setOptions(physicsOptions);
                 toggleBtn.innerText = 'ØªØºÛŒÛŒØ± Ø¨Ù‡ Ø­Ø§Ù„Øª Ø³Ø§Ø²Ù…Ø§Ù†â€ŒÛŒØ§ÙØªÙ‡';
             }
        });

        // --- Ù‡Ù€: Ù…Ù†Ø·Ù‚ Ù¾Ø§Ù¾â€ŒØ¢Ù¾ (Modal) ---
        
        const modal = document.getElementById('custom-modal');
        const backdrop = document.getElementById('modal-backdrop');
        const modalHeader = document.getElementById('modal-header');
        const nodeForm = document.getElementById('node-form');
        const titleInput = document.getElementById('node-title');
        const descInput = document.getElementById('node-desc');
        const actionInput = document.getElementById('node-action');
        const probabilityInput = document.getElementById('node-probability');
        const anxietyInput = document.getElementById('node-anxiety');
        const dueDateInput = document.getElementById('node-dueDate');
        const saveBtn = document.getElementById('modal-save-btn');
        const closeBtn = document.getElementById('modal-close-btn');
        const actionButtons = document.getElementById('action-buttons'); 
        const happenedBtn = document.getElementById('happened-btn');
        const notHappenedBtn = document.getElementById('not-happened-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const choiceButtonsDiv = document.getElementById('choice-buttons');
        const choiceAddBtn = document.getElementById('choice-add-btn');
        const choiceEditBtn = document.getElementById('choice-edit-btn');
        
        let currentMode = 'choice';
        let selectedNodeId = null; 

        function openModal(mode, nodeId) {
            currentMode = mode;
            selectedNodeId = nodeId;
            
            choiceButtonsDiv.style.display = 'none';
            nodeForm.style.display = 'none';
            actionButtons.style.display = 'none';
            saveBtn.style.display = 'none';

            if (mode === 'choice') {
                modalHeader.innerText = `Ú¯Ø±Ù‡: ${nodeDataStore[nodeId]?.title || 'Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'}`;
                choiceButtonsDiv.style.display = 'block';
            } else if (mode === 'add') {
                modalHeader.innerText = 'Ø§ÙØ²ÙˆØ¯Ù† Ø§Ù†Ø´Ø¹Ø§Ø¨ Ø¬Ø¯ÛŒØ¯';
                nodeForm.reset();
                Array.from(nodeForm.elements).forEach(el => el.disabled = false);
                probabilityInput.value = 5; 
                anxietyInput.value = 50;
                nodeForm.style.display = 'block';
                saveBtn.innerText = 'Ø§ÙØ²ÙˆØ¯Ù†';
                saveBtn.style.display = 'inline-block';
                
            } else if (mode === 'edit') {
                modalHeader.innerText = 'ÙˆÛŒØ±Ø§ÛŒØ´ / Ù‡Ø±Ø³ / Ø­Ø°Ù';
                saveBtn.innerText = 'Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª';
                nodeForm.style.display = 'block';
                
                const nodeData = nodeDataStore[nodeId];
                if (!nodeData) return closeModal();

                titleInput.value = nodeData.title;
                descInput.value = nodeData.description || '';
                actionInput.value = nodeData.actionPlan || '';
                probabilityInput.value = nodeData.probability || 5; 
                anxietyInput.value = nodeData.anxiety || 50;
                dueDateInput.value = nodeData.dueDate || '';

                if (nodeId === rootId || nodeData.pruned) { 
                    actionButtons.style.display = 'none'; 
                } else {
                    actionButtons.style.display = 'flex';
                }
                
                if (nodeData.pruned) {
                    Array.from(nodeForm.elements).forEach(el => el.disabled = true);
                    saveBtn.style.display = 'none'; 
                } else {
                    saveBtn.style.display = 'inline-block';
                }
            }
            
            modal.style.display = 'flex'; 
            backdrop.style.display = 'block';
        }

        function closeModal() {
             modal.style.display = 'none';
             backdrop.style.display = 'none';
             selectedNodeId = null;
        }
        
        closeBtn.onclick = closeModal;
        backdrop.onclick = closeModal;
        
        choiceAddBtn.onclick = function() {
            openModal('add', selectedNodeId); 
        };
        choiceEditBtn.onclick = function() {
            openModal('edit', selectedNodeId);
        };
        
        saveBtn.onclick = function() {
            const localProb = parseFloat(probabilityInput.value) || 0;
            
            let parentNodeData = null;
            if (currentMode === 'add') {
                 parentNodeData = nodeDataStore[selectedNodeId];
            } else if (currentMode === 'edit' && selectedNodeId !== rootId) {
                const parentEdge = edges.get({ filter: e => e.to === selectedNodeId });
                if (parentEdge.length > 0) {
                    parentNodeData = nodeDataStore[parentEdge[0].from];
                }
            }
            const parentCumProb = parentNodeData ? parentNodeData.cumulativeProbability : 10;
            
            const newCumulativeProb = (selectedNodeId === rootId && currentMode === 'edit') 
                ? localProb 
                : parentCumProb * (localProb / 10.0);

            const nodeData = {
                title: titleInput.value || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†',
                description: descInput.value,
                actionPlan: actionInput.value,
                probability: localProb, 
                cumulativeProbability: newCumulativeProb, 
                anxiety: anxietyInput.value,
                dueDate: dueDateInput.value,
                pruned: false,
            };
            
            const displayData = { 
                label: nodeData.title,
                ...getNodeSizeProps(nodeData.cumulativeProbability)
            }; 

            if (currentMode === 'add') {
                try {
                    const newNodeId = Date.now();
                    nodeDataStore[newNodeId] = { id: newNodeId, ...nodeData };
                    nodes.add({ id: newNodeId, ...displayData });
                    edges.add({ from: selectedNodeId, to: newNodeId });
                    saveCurrentMapData(); 
                } catch (err) { alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ú¯Ø±Ù‡: ' + err); }
            } else if (currentMode === 'edit') {
                try {
                    nodeDataStore[selectedNodeId] = { ...nodeDataStore[selectedNodeId], ...nodeData, id: selectedNodeId };
                    nodes.update({ id: selectedNodeId, ...displayData });
                    
                    updateChildrenCumulativeProb(selectedNodeId);
                    
                    saveCurrentMapData(); 
                } catch (err) { alert('Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ú¯Ø±Ù‡: ' + err); }
            }
            closeModal();
        };

        // --- Ùˆ: Ù…Ù†Ø·Ù‚ Ú©Ù„ÛŒÚ© ---
        network.on('click', function(params) {
             if (params.nodes.length > 0) {
                 const nodeId = params.nodes[0];
                 openModal('choice', nodeId); 
             }
         });
         
        // --- ØªØ§Ø¨Ø¹ Ø¢Ù¾Ø¯ÛŒØª Ø¨Ø§Ø²Ú¯Ø´ØªÛŒ ÙØ±Ø²Ù†Ø¯Ø§Ù† ---
        function updateChildrenCumulativeProb(parentNodeId) {
            const parentNodeData = nodeDataStore[parentNodeId];
            if (!parentNodeData) return;
            
            const parentCumProb = parentNodeData.cumulativeProbability;
            const childEdges = edges.get({ filter: e => e.from === parentNodeId });

            childEdges.forEach(edge => {
                const childId = edge.to;
                const childNodeData = nodeDataStore[childId];
                if (!childNodeData) return;
                
                const childLocalProb = childNodeData.probability;
                const newChildCumProb = parentCumProb * (childLocalProb / 10.0);
                
                childNodeData.cumulativeProbability = newChildCumProb;
                
                nodes.update({ 
                    id: childId, 
                    ...getNodeSizeProps(newChildCumProb) 
                });
                
                updateChildrenCumulativeProb(childId);
            });
        }

        
        // --- Ø²: Ù…Ù†Ø·Ù‚ Ù‡Ø±Ø³ Ú©Ø±Ø¯Ù† Ùˆ Ø§Ø±ØªÙ‚Ø§Ø¡ ---
        happenedBtn.onclick = function() { 
            if (confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ú¯Ø±Ù‡ Ø¨Ù‡ Ø±ÛŒØ´Ù‡ Ø¬Ø¯ÛŒØ¯ ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯Ù‡ Ùˆ Ø¨Ù‚ÛŒÙ‡ Ø§Ù†Ø´Ø¹Ø§Ø¨Ø§Øª Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.")) {
                promoteNodeToRoot(selectedNodeId); 
                saveCurrentMapData(); 
                closeModal(); 
            }
        };
        
        notHappenedBtn.onclick = function() { 
            pruneSiblings(selectedNodeId, false); 
            saveCurrentMapData(); 
            closeModal(); 
        };

        function pruneSiblings(nodeId, didHappen) {
            const parentEdge = edges.get({ filter: e => e.to === nodeId });
            if (parentEdge.length === 0) return;
            const parentId = parentEdge[0].from;
            const siblingEdges = edges.get({ filter: e => e.from === parentId });
            siblingEdges.forEach(edge => {
                const siblingId = edge.to;
                let shouldPrune = false;
                if (didHappen && siblingId !== nodeId) shouldPrune = true;
                if (!didHappen && siblingId === nodeId) shouldPrune = true;
                if (shouldPrune) pruneNodeAndChildren(siblingId);
            });
        }
        function pruneNodeAndChildren(nodeId) {
             if (nodeDataStore[nodeId] && !nodeDataStore[nodeId].pruned) {
                 nodeDataStore[nodeId].pruned = true;
                 nodes.update({ id: nodeId, color: prunedColor, font: prunedFont });
                 const childEdges = edges.get({ filter: e => e.from === nodeId });
                 childEdges.forEach(edge => pruneNodeAndChildren(edge.to));
             }
        }

        function getDescendants(startNodeId) {
            const descendants = new Set();
            const queue = [startNodeId];
            const visited = new Set([startNodeId]); 

            while (queue.length > 0) {
                const currentId = queue.shift();
                
                const childEdges = edges.get({ filter: e => e.from === currentId });
                
                for (const edge of childEdges) {
                    const childId = edge.to;
                    if (!visited.has(childId)) {
                        visited.add(childId);
                        descendants.add(childId);
                        queue.push(childId);
                    }
                }
            }
            return descendants;
        }

        function promoteNodeToRoot(nodeId) {
            if (nodeId === rootId) return; 

            const promotedNodeData = nodeDataStore[nodeId];
            if (!promotedNodeData) return;

            const descendantIds = getDescendants(nodeId);
            const allNodeIds = nodes.getIds();
            const nodesToDelete = allNodeIds.filter(id => id !== rootId && !descendantIds.has(id));
            const edgesToUpdate = edges.get({ filter: e => e.from === nodeId });
            const edgesToUpdateIds = new Set(edgesToUpdate.map(e => e.id));
            const allEdgeIds = edges.getIds();
            const edgesToDelete = allEdgeIds.filter(id => !edgesToUpdateIds.has(id));

            const newRootData = {
                ...promotedNodeData, 
                id: rootId,          
                probability: 10,     
                cumulativeProbability: 10, 
                pruned: false        
            };
            nodeDataStore[rootId] = newRootData;

            nodes.update({
                id: rootId,
                label: newRootData.title,
                ...getNodeSizeProps(10), 
                color: { background: '#4fc3f7', border: '#81d4fa' }, 
                font: { color: 'white', size: 14, multi: false }
            });

            const updatedEdges = edgesToUpdate.map(edge => ({
                id: edge.id,
                from: rootId 
            }));
            edges.update(updatedEdges);

            nodes.remove(nodesToDelete);
            edges.remove(edgesToDelete);
            
            nodesToDelete.forEach(id => {
                delete nodeDataStore[id];
            });

            updateChildrenCumulativeProb(rootId); 
        }
        
        // --- Ø­: Ù…Ù†Ø·Ù‚ Ø­Ø°Ù ---
        deleteBtn.onclick = function() { if (!selectedNodeId) return; if (confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø­Ø°Ù ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.")) { deleteNodeAndChildren(selectedNodeId); saveCurrentMapData(); closeModal(); } };
        function deleteNodeAndChildren(startNodeId) {
            const nodesToDelete = new Set(); const edgesToDelete = new Set(); const queue = [startNodeId];
            const incomingEdge = edges.get({ filter: e => e.to === startNodeId }); if (incomingEdge.length > 0) edgesToDelete.add(incomingEdge[0].id);
            while (queue.length > 0) { const currentId = queue.shift(); if (!nodesToDelete.has(currentId)) nodesToDelete.add(currentId); const outgoingEdges = edges.get({ filter: e => e.from === currentId }); outgoingEdges.forEach(edge => { if (!edgesToDelete.has(edge.id)) { edgesToDelete.add(edge.id); const childId = edge.to; if (!nodesToDelete.has(childId)) queue.push(childId); } }); }
            nodes.remove(Array.from(nodesToDelete)); edges.remove(Array.from(edgesToDelete)); nodesToDelete.forEach(id => { delete nodeDataStore[id]; });
        }

        // --- Ø·: Ù…Ù†Ø·Ù‚ Ø°Ø®ÛŒØ±Ù‡ Ø³Ø§Ø²ÛŒ Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú†Ù†Ø¯ Ù†Ù‚Ø´Ù‡ ---
        const localStorageKey = 'chaosMapMultiData_v2'; 
        const lastActiveMapKey = 'chaosMapLastActive_v2';
        const visitedKey = 'chaosNavigatorVisited_v1';

        function saveAllData() { try { localStorage.setItem(localStorageKey, JSON.stringify(allMapsData)); localStorage.setItem(lastActiveMapKey, currentMapId); console.log("All maps data saved."); } catch (error) { console.error("Error saving all maps data:", error); } }
        function saveCurrentMapData() { if (!currentMapId || !allMapsData[currentMapId]) return; allMapsData[currentMapId].nodes = nodes.get({ fields: ['id', 'label', 'fixed', 'x', 'y'] }); allMapsData[currentMapId].edges = edges.get(); allMapsData[currentMapId].nodeStore = nodeDataStore; saveAllData(); }
        
        function showMainUI() {
            document.getElementById('visualization').style.display = 'block';
            document.querySelector('h1').style.display = 'block';
            document.getElementById('toggle-layout-btn').style.display = 'block';
            document.getElementById('help-text').style.display = 'block';
        }
        
        function loadMap(mapId) { 
            if (!allMapsData[mapId]) { console.error(`Map ${mapId} not found.`); const mapIds = Object.keys(allMapsData); if (mapIds.length > 0) loadMap(mapIds[0]); else createNewMap(true); return; } 
            const mapData = allMapsData[mapId]; 
            currentMapId = mapId; 
            nodeDataStore = mapData.nodeStore || {}; 
            const loadedNodes = mapData.nodes.map(savedNode => { 
                const customData = nodeDataStore[savedNode.id]; 
                if (!customData) return null; 
                const isPruned = customData.pruned; 
                const isRoot = savedNode.id === rootId; 
                
                const probToUse = customData.cumulativeProbability !== undefined 
                    ? customData.cumulativeProbability 
                    : customData.probability; 
                const sizeProps = getNodeSizeProps(probToUse);

                return { 
                    id: savedNode.id, 
                    label: customData.title, 
                    shape: 'circle', 
                    ...sizeProps, 
                    color: isPruned ? prunedColor.background : (isRoot ? '#4fc3f7' : '#334155'), 
                    font: isPruned ? prunedFont : (isRoot ? {color: 'white', size: 14, multi: false} : {color: '#e0f2fe', size: 14, multi: false}), 
                    fixed: savedNode.fixed, 
                    x: savedNode.x, 
                    y: savedNode.y 
                }; 
            }).filter(node => node !== null); 
            nodes.clear(); 
            nodes.add(loadedNodes); 
            edges.clear(); 
            edges.add(mapData.edges); 
            updateMapSelector(); 
            localStorage.setItem(lastActiveMapKey, currentMapId); 
            console.log(`Map "${mapData.name}" loaded.`); 
            
            showMainUI();

            // ØªØºÛŒÛŒØ± Û±: Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† ÙÙˆÚ©ÙˆØ³ Ø¯Ø§Ø®Ù„ setTimeout
            setTimeout(() => {
                if (!isHierarchical) {
                    nodes.update({ id: rootId, fixed: true, x: 0, y: 0 }); 
                }
                network.focus(rootId, {
                    scale: 1.0, 
                    animation: {
                        duration: 800, 
                        easingFunction: 'easeInOutQuad'
                    }
                });
            }, 0); // ØªØ§Ø®ÛŒØ± 0 Ù‡Ù… Ú©Ø§ÙÛŒ Ø§Ø³Øª ØªØ§ Ø¯Ø± Ú†Ø±Ø®Ù‡ Ø¨Ø¹Ø¯ÛŒ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
        }
        
        // ØªØºÛŒÛŒØ± Û³: ØªØ§Ø¨Ø¹ createNewMap Ø¨Ø±Ø§ÛŒ Ù¾Ø°ÛŒØ±Ø´ Ù†Ø§Ù… Ø§Ø² ÙˆØ±ÙˆØ¯ÛŒ
        function createNewMap(isDefault = false, mapNameFromInput = null) { 
            let mapName = mapNameFromInput; // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù†Ø§Ù… ÙˆØ±ÙˆØ¯ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
            if (isDefault) {
                mapName = "Ù†Ù‚Ø´Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶";
            } else if (!mapName) { // Ø§Ú¯Ø± Ù†Ø§Ù… ÙˆØ±ÙˆØ¯ÛŒ null Ø¨ÙˆØ¯ (ÛŒØ¹Ù†ÛŒ Ø¯Ú©Ù…Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø²Ø¯Ù‡ Ù†Ø´Ø¯Ù‡)
                // Ø§Ú¯Ø± Ø§Ø² Ø¬Ø§ÛŒ Ø¯ÛŒÚ¯Ø±ÛŒ (Ù…Ø«Ù„Ø§ Ø¯Ú©Ù…Ù‡ ÙØ±Ø¶ÛŒ Ø¯Ø± UI Ø§ØµÙ„ÛŒ) ØµØ¯Ø§ Ø²Ø¯Ù‡ Ø´ÙˆØ¯ØŒ prompt Ø¨Ù¾Ø±Ø³
                 mapName = prompt("Ù†Ø§Ù… Ù†Ù‚Ø´Ù‡ Ø¬Ø¯ÛŒØ¯:", `Ù†Ù‚Ø´Ù‡ ${Object.keys(allMapsData).length + 1}`);
                 if (!mapName) return; // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØµØ±Ø§Ù Ø¯Ø§Ø¯
            }
             if (!mapName) mapName = `Ù†Ù‚Ø´Ù‡ ${Object.keys(allMapsData).length + 1}`; // ÛŒÚ© Ù†Ø§Ù… Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø§Ù„ÛŒ Ù…Ø§Ù†Ø¯Ù†
            
            const newMapId = isDefault ? defaultMapId : `map_${Date.now()}`; 
            const defaultNodeData = { ...rootData }; 
            allMapsData[newMapId] = { id: newMapId, name: mapName, nodes: [{ id: rootId, label: defaultNodeData.title }], edges: [], nodeStore: { [rootId]: defaultNodeData } }; 
            loadMap(newMapId); 
            saveAllData(); 
        }
        function deleteCurrentMap() { 
            if (!currentMapId || currentMapId === defaultMapId) { alert("Ù†Ù‚Ø´Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù‚Ø§Ø¨Ù„ Ø­Ø°Ù Ù†ÛŒØ³Øª."); return; } 
            if (Object.keys(allMapsData).length <= 1) { alert("Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù†Ù‚Ø´Ù‡ Ø¨Ø§ÛŒØ¯ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯."); return; } 
            if (confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ù†Ù‚Ø´Ù‡ "${allMapsData[currentMapId].name}" Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) { 
                delete allMapsData[currentMapId]; 
                const remainingMapIds = Object.keys(allMapsData); 
                loadMap(remainingMapIds[0]); 
                saveAllData(); 
            } 
        }
        function updateMapSelector() { 
             const selector = document.getElementById('map-selector');
             if (selector) {
                selector.innerHTML = ''; 
                Object.values(allMapsData).forEach(map => { 
                    const option = document.createElement('option'); 
                    option.value = map.id; 
                    option.textContent = map.name; 
                    if (map.id === currentMapId) option.selected = true; 
                    selector.appendChild(option); 
                });
             }
        }
        
        // --- ÛŒ: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---
        
        const welcomeModal = document.getElementById('welcome-modal');
        const welcomeBackdrop = document.getElementById('welcome-modal-backdrop');
        const welcomeMapSelector = document.getElementById('welcome-map-selector');
        const welcomeLoadSection = document.getElementById('welcome-load-section');
        const welcomeNewMapNameInput = document.getElementById('welcome-new-map-name'); // Ú¯Ø±ÙØªÙ† input Ø¬Ø¯ÛŒØ¯

        const firstVisitModal = document.getElementById('first-visit-modal');
        const firstVisitBackdrop = document.getElementById('first-visit-backdrop');
        
        function populateWelcomeSelector() {
            welcomeMapSelector.innerHTML = ''; 
            const mapIds = Object.keys(allMapsData);
            
            if (mapIds.length > 0) {
                welcomeLoadSection.style.display = 'block';
                mapIds.forEach(mapId => {
                    const mapName = allMapsData[mapId].name;
                    const option = document.createElement('option');
                    option.value = mapId;
                    option.textContent = mapName;
                    welcomeMapSelector.appendChild(option);
                });
                const lastActiveId = localStorage.getItem(lastActiveMapKey);
                if (lastActiveId && allMapsData[lastActiveId]) {
                    welcomeMapSelector.value = lastActiveId;
                }
            } else {
                welcomeLoadSection.style.display = 'none';
            }
        }

        function closeWelcomeModal() {
            welcomeModal.style.display = 'none';
            welcomeBackdrop.style.display = 'none';
        }

        function initialLoad() { 
            const savedDataString = localStorage.getItem(localStorageKey); 
            if (savedDataString) { 
                try { 
                    allMapsData = JSON.parse(savedDataString); 
                    if (Object.keys(allMapsData).length === 0) throw new Error("Empty data"); 
                } catch (error) { 
                    console.error("Error parsing saved data:", error); 
                    allMapsData = {}; 
                } 
            } else { 
                allMapsData = {}; 
            } 
            
            populateWelcomeSelector();

            const hasVisited = localStorage.getItem(visitedKey);
            
            if (!hasVisited) {
                localStorage.setItem(visitedKey, 'true');
                firstVisitModal.style.display = 'block';
                firstVisitBackdrop.style.display = 'block';
            } else {
                welcomeModal.style.display = 'block';
                welcomeBackdrop.style.display = 'block';
            }
        }
        
        // --- Ú©: Ø§ØªØµØ§Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± ---
        const mapSelector = document.getElementById('map-selector');
        const newMapBtn = document.getElementById('new-map-btn');
        const deleteMapBtn = document.getElementById('delete-map-btn');

        if (mapSelector) {
            mapSelector.addEventListener('change', (event) => { 
                saveCurrentMapData(); 
                loadMap(event.target.value); 
            });
        }
        if (newMapBtn) {
            newMapBtn.addEventListener('click', () => createNewMap(false));
        }
        if (deleteMapBtn) {
            deleteMapBtn.addEventListener('click', deleteCurrentMap);
        }

        // Ø§ØªØµØ§Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ
        document.getElementById('first-visit-continue-btn').onclick = function() {
            firstVisitModal.style.display = 'none';
            firstVisitBackdrop.style.display = 'none';
            welcomeModal.style.display = 'block';
            welcomeBackdrop.style.display = 'block';
        };
        
        // ØªØºÛŒÛŒØ± Û´: Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¯Ú©Ù…Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù‚Ø´Ù‡ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† Ø§Ø² input
        document.getElementById('welcome-create-btn').onclick = function() {
            const newName = welcomeNewMapNameInput.value.trim();
            if (!newName) {
                alert("Ù„Ø·ÙØ§ ÛŒÚ© Ù†Ø§Ù… Ø¨Ø±Ø§ÛŒ Ù†Ù‚Ø´Ù‡ Ø¬Ø¯ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
                welcomeNewMapNameInput.focus();
                return;
            }
            // ØµØ¯Ø§ Ø²Ø¯Ù† createNewMap Ø¨Ø§ Ù†Ø§Ù… ÙˆØ±ÙˆØ¯ÛŒ
            createNewMap(false, newName); 
            // loadMap Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ Ù…ÙˆØ¯Ø§Ù„ Ø±Ø§ Ù…ÛŒâ€ŒØ¨Ù†Ø¯Ø¯ (Ø§Ú¯Ø± Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´Ø¯)
            if (currentMapId) { // ÙÙ‚Ø· Ø§Ú¯Ø± Ù†Ù‚Ø´Ù‡ ÙˆØ§Ù‚Ø¹Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯
                 closeWelcomeModal();
            }
        };

        document.getElementById('welcome-load-btn').onclick = function() {
            const selectedMapId = welcomeMapSelector.value;
            if (selectedMapId) {
                loadMap(selectedMapId);
                closeWelcomeModal();
            } else {
                // Ø§ÛŒÙ† Ø­Ø§Ù„Øª Ù†Ø¨Ø§ÛŒØ¯ Ø±Ø® Ø¯Ù‡Ø¯ Ø§Ú¯Ø± welcomeLoadSection Ù…Ø®ÙÛŒ Ø¨Ø§Ø´Ø¯
                alert("Ù†Ù‚Ø´Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯."); 
            }
        };


        // Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        initialLoad();

    </script>


<!-- BEGIN: Telegram Web App integration (injected, original content kept intact) -->
<script async src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
(function(){
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  function safe(fn){ try{ fn(); } catch(e){ console.warn(e); } }
  if(!tg) return;
  safe(()=>tg.ready());
  safe(()=>tg.expand());
  // Configure MainButton to offer the final HTML file download or send a small notice to the bot.
  safe(()=>tg.MainButton.setText('Ø§Ø±Ø³Ø§Ù„ / Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„'));
  safe(()=>tg.MainButton.show());
  safe(()=>tg.BackButton.show());
  // When pressed, attempt to send a small signal to the bot; if not possible, download the full HTML as a file.
  safe(()=>tg.MainButton.onClick(function(){
    try {
      // Try to notify the bot that the user requests the full file.
      tg.sendData(JSON.stringify({ action: 'request_full_html', filename: 'ChaosMiniApp_Final.html', timestamp: Date.now() }));
    } catch(err) {
      // Fallback: trigger client-side download of the full HTML page.
      try {
        const htmlContent = document.documentElement.outerHTML;
        const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ChaosMiniApp_Final.html';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch(e2){
        // As a last resort, show a popup (if available) or alert.
        if(tg.showPopup){
          tg.showPopup({ title: 'Ø®Ø·Ø§', message: 'Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù…Ù…Ú©Ù† Ù†Ø´Ø¯.' });
        } else {
          alert('Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù…Ù…Ú©Ù† Ù†Ø´Ø¯.');
        }
      }
    }
  }));
  // Close behavior for Back button
  try { tg.BackButton.onClick(()=>tg.close()); } catch(e){}
})();
</script>
<!-- END: Telegram Web App integration -->
</body>
</html>
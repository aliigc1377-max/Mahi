<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no"> {/* Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ Ù†Ù…Ø§ÛŒØ´ Mini App */}
    <title>Ù†Ø§ÙˆØ¨Ø± Ø¢Ø´ÙˆØ¨ (Ù…ÛŒÙ†ÛŒ Ø§Ù¾)</title>

    <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" type="text/css" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
             /* --tg-theme-bg-color: #0f172a; /* Ù…Ø«Ø§Ù„: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ØªÙ… ØªÙ„Ú¯Ø±Ø§Ù… (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) */
             /* --tg-theme-text-color: #e0f2fe; */
             /* --tg-theme-button-color: #4fc3f7; */
             /* --tg-theme-button-text-color: #0f172a; */
        }

        body {
            font-family: "Segoe UI", Tahoma, sans-serif;
            background-color: var(--tg-theme-bg-color, #0f172a); /* Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…ØªØºÛŒØ± ÛŒØ§ Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ */
            color: var(--tg-theme-text-color, #e0f2fe);
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ù…ØªÙ† Ù†Ø§Ø®ÙˆØ§Ø³ØªÙ‡ */
            user-select: none; 
           -webkit-user-select: none;
        }
        
        /* UI Ø§ØµÙ„ÛŒ Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ Ù…Ø®ÙÛŒ Ø§Ø³Øª */
        h1, #toggle-layout-btn, #help-text, #visualization {
            display: none;
        }

        h1 {
            position: absolute;
            top: 10px;
            right: 15px; /* Ú©Ù…ÛŒ ÙØ§ØµÙ„Ù‡ Ø¨ÛŒØ´ØªØ± */
            z-index: 10;
            color: var(--tg-theme-link-color, #4fc3f7); /* Ø±Ù†Ú¯ Ù„ÛŒÙ†Ú© ØªÙ… ÛŒØ§ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ */
            opacity: 0.8;
            font-size: 1.4em; /* Ú©Ù…ÛŒ Ú©ÙˆÚ†Ú©â€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        #visualization {
            width: 100vw;
            height: 100vh;
            background-color: #1e293b;
            background-image: radial-gradient(circle, #2a3a50 0%, #1e293b 70%);
        }

        #toggle-layout-btn {
            position: absolute;
            top: 15px; /* ØªÙ†Ø¸ÛŒÙ… Ù…ÙˆÙ‚Ø¹ÛŒØª */
            left: 15px;
            z-index: 10;
            background-color: var(--tg-theme-button-color, #4fc3f7); 
            color: var(--tg-theme-button-text-color, #0f172a); 
            border: none;
            padding: 8px 12px; /* Ú©Ù…ÛŒ Ú©ÙˆÚ†Ú©â€ŒØªØ± */
            border-radius: 5px;
            cursor: pointer;
            font-family: "Segoe UI", Tahoma, sans-serif;
            font-weight: bold;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #toggle-layout-btn:hover {
            filter: brightness(1.1); /* Ø§ÙÚ©Øª Ù‡Ø§ÙˆØ± Ø¹Ù…ÙˆÙ…ÛŒ */
        }

        #help-text {
            position: absolute;
            bottom: 10px; /* Ú©Ù…ÛŒ Ø¨Ø§Ù„Ø§ØªØ± */
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            color: #fff;
            background-color: rgba(30, 41, 59, 0.5); 
            backdrop-filter: blur(5px);
            padding: 5px 15px;
            border-radius: 5px;
            border: 1px solid rgba(227, 242, 253, 0.1);
            font-size: 0.8em; /* Ú©ÙˆÚ†Ú©â€ŒØªØ± */
        }
        
        /* --- CSS Ù¾Ø§Ù¾â€ŒØ¢Ù¾ (Modal) --- */
        .modal-backdrop {
            display: none;
            position: fixed;
            z-index: 99;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); 
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ù¾Ø§ÛŒÙ‡ Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ */
        .glass-modal {
             display: none;
             position: fixed;
             left: 50%;
             top: 50%;
             transform: translate(-50%, -50%);
             width: 90%; 
             max-width: 450px; 
             background-color: rgba(179, 229, 252, 0.15); 
             backdrop-filter: blur(15px); 
             border: 1px solid rgba(227, 242, 253, 0.2); 
             border-radius: 12px;
             box-shadow: 0 10px 30px rgba(0,0,0,0.5);
             box-sizing: border-box;
        }

        /* Ù…ÙˆØ¯Ø§Ù„ Ø§ØµÙ„ÛŒ (ÙˆÛŒØ±Ø§ÛŒØ´ Ú¯Ø±Ù‡) */
        #custom-modal {
             z-index: 100;
             max-height: 85vh; 
             display: flex; /* Ø¨Ø§ÛŒØ¯ ÙÙ„Ú©Ø³ Ø¨Ø§Ø´Ø¯ ØªØ§ overflow Ú©Ø§Ø± Ú©Ù†Ø¯ */
             flex-direction: column;
        }
        
        #modal-header {
            padding: 15px 20px;
            font-size: 1.2em;
            font-weight: bold;
            background-color: rgba(179, 229, 252, 0.1); 
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            color: var(--tg-theme-text-color, #e0f2fe);
            border-bottom: 1px solid rgba(227, 242, 253, 0.1);
            flex-shrink: 0; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©ÙˆÚ†Ú© Ø´Ø¯Ù† Ù‡Ø¯Ø± */
        }
        
        #modal-body {
            padding: 20px;
            overflow-y: auto; 
            flex-grow: 1; /* Ø¨Ø¯Ù†Ù‡ Ø¨Ø²Ø±Ú¯ Ø´ÙˆØ¯ ØªØ§ Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø®ÙˆØ±Ø¯ */
        }

        #choice-buttons {
            display: none; 
            text-align: center;
        }
        #choice-buttons p {
             color: #b3e5fc; 
        }
        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„ */
         #choice-buttons button {
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            border-radius: 8px; 
            border: none;
            font-family: "Segoe UI", Tahoma, sans-serif;
            font-weight: bold;
            width: 100%; 
            box-sizing: border-box; 
            margin: 10px 0;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        #choice-add-btn { background-color: var(--tg-theme-button-color, #4fc3f7); color: var(--tg-theme-button-text-color, #0f172a); } 
        #choice-edit-btn { background-color: #b3e5fc; color: #0f172a; } 

        #choice-add-btn:hover { filter: brightness(1.1); }
        #choice-edit-btn:hover { filter: brightness(1.1); }

        #node-form { display: none; }
        #node-form .form-group { margin-bottom: 15px; }
        #node-form label { display: block; margin-bottom: 5px; font-weight: bold; color: #b3e5fc; }
        
        #node-form input[type="text"],
        #node-form input[type="date"],
        #node-form textarea { 
            width: 100%; 
            box-sizing: border-box; 
            padding: 10px; 
            border-radius: 8px; 
            border: 1px solid rgba(227, 242, 253, 0.2); 
            background-color: rgba(15, 23, 42, 0.5); 
            color: var(--tg-theme-text-color, #e0f2fe); 
            font-family: "Segoe UI", Tahoma, sans-serif; 
            font-size: 1em; 
            transition: all 0.2s ease;
        }
        
        #node-form ::placeholder {
            color: #64748b; 
            opacity: 0.8;
        }

        #node-form input[type="text"]:focus,
        #node-form input[type="date"]:focus,
        #node-form textarea:focus { 
            border-color: var(--tg-theme-link-color, #4fc3f7); 
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.5);
            outline: none;
        }

        #node-form textarea { resize: vertical; min-height: 60px; }
        #node-form input[type="range"] { width: 100%; box-sizing: border-box; cursor: pointer;}
        #node-form small { font-size: 0.8em; color: #94a3b8; margin-top: 5px; display: block; } 
        #node-form input:disabled,
        #node-form textarea:disabled { background-color: #1e293b; opacity: 0.5; cursor: not-allowed; }

        #modal-footer {
            padding: 15px 20px;
            background-color: rgba(179, 229, 252, 0.1); 
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            display: flex;
            justify-content: center; /* Ù…Ø±Ú©Ø² Ú†ÛŒÙ† Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ú©Ø´Ù† */
            flex-wrap: wrap; 
            gap: 10px; 
            border-top: 1px solid rgba(227, 242, 253, 0.1);
             flex-shrink: 0; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©ÙˆÚ†Ú© Ø´Ø¯Ù† ÙÙˆØªØ± */
        }
        
         /* ØªØºÛŒÛŒØ± Û²: Ø­Ø°Ù Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡/Ø¨Ø³ØªÙ† Ø§Ø² HTML ÙÙˆØªØ± */
         #modal-footer > div:last-child {
              display: none; 
         }
        
        /* Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ú©Ø´Ù† */
        #action-buttons {
             display: none; /* Ø¯Ø± Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ Ù…Ø®ÙÛŒ */
             /* flex-grow: 1;  Ù†ÛŒØ§Ø²ÛŒ Ù†ÛŒØ³Øª */
             display: flex;
             gap: 10px;
             justify-content: center; /* Ù…Ø±Ú©Ø² Ú†ÛŒÙ† Ú©Ø±Ø¯Ù† */
             width: 100%; /* Ø¹Ø±Ø¶ Ú©Ø§Ù…Ù„ Ø¨Ú¯ÛŒØ±Ù†Ø¯ */
        }
         #action-buttons button { 
             margin-right: 0; 
             padding: 10px 15px;
             border: none;
             border-radius: 5px;
             cursor: pointer;
             font-family: "Segoe UI", Tahoma, sans-serif;
             font-weight: bold;
             flex-grow: 1; /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ ÙØ¶Ø§ Ø±Ø§ ØªÙ‚Ø³ÛŒÙ… Ú©Ù†Ù†Ø¯ */
             transition: filter 0.2s ease;
             box-shadow: 0 2px 4px rgba(0,0,0,0.15);
         }
        
        #happened-btn { background-color: #2dd4bf; color: #0f172a; } 
        #not-happened-btn { background-color: #f43f5e; color: white; } 
        #delete-btn { background-color: #e11d48; color: white; } 

        #happened-btn:hover { filter: brightness(1.1); }
        #not-happened-btn:hover { filter: brightness(1.1); }
        #delete-btn:hover { filter: brightness(1.1); }

        /* --- Ù…ÙˆØ¯Ø§Ù„ Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ (Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù‚Ø´Ù‡) --- */
        #welcome-modal {
            z-index: 101; 
            padding: 20px;
        }
        #welcome-modal h2 {
            margin-top: 0;
            color: var(--tg-theme-text-color, #e0f2fe);
            text-align: center;
        }
        
        #welcome-new-map-name {
            width: 100%; 
            box-sizing: border-box; 
            padding: 10px; 
            border-radius: 8px; 
            border: 1px solid rgba(227, 242, 253, 0.2); 
            background-color: rgba(15, 23, 42, 0.5); 
            color: var(--tg-theme-text-color, #e0f2fe); 
            font-family: "Segoe UI", Tahoma, sans-serif; 
            font-size: 1em; 
            transition: all 0.2s ease;
            margin-bottom: 15px; 
        }
         #welcome-new-map-name::placeholder {
            color: #64748b; 
            opacity: 0.8;
        }
         #welcome-new-map-name:focus {
            border-color: var(--tg-theme-link-color, #4fc3f7); 
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.5);
            outline: none;
        }
        
        #welcome-load-section {
            border-top: 1px solid rgba(227, 242, 253, 0.2);
            padding-top: 15px;
            margin-top: 15px;
        }
        #welcome-load-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #b3e5fc;
        }
        #welcome-map-selector {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(227, 242, 253, 0.2);
            background-color: rgba(15, 23, 42, 0.5);
            color: var(--tg-theme-text-color, #e0f2fe);
            font-family: "Segoe UI", Tahoma, sans-serif;
            font-size: 1em;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
         /* ØªØºÛŒÛŒØ± Û²: Ø­Ø°Ù Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ HTML Ø§Ø² Ù…ÙˆØ¯Ø§Ù„ Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ */
        #welcome-create-btn, #welcome-load-btn {
             display: none; 
        }

        /* --- Ø­Ø°Ù Ù…ÙˆØ¯Ø§Ù„ Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø²Ø¯ÛŒØ¯ --- */

        /* --- Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ --- */
        @media (max-width: 600px) {
            h1 {
                font-size: 1.2em;
                top: 15px;
                right: 15px;
            }
            #toggle-layout-btn {
                top: 15px;
                left: 15px;
                padding: 8px 12px;
                font-size: 0.8em;
            }
            #help-text {
                font-size: 0.8em;
                bottom: 10px; /* ØªÙ†Ø¸ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ MainButton ØªÙ„Ú¯Ø±Ø§Ù… */
                width: 90%;
                text-align: center;
            }
            #modal-body {
                padding: 15px;
            }
            #modal-footer {
                 padding: 10px 15px; /* Ú©Ù…ÛŒ Ú©Ù…ØªØ± */
            }
             #action-buttons {
                 gap: 8px;
             }
             #action-buttons button {
                 padding: 8px 10px;
                 font-size: 0.9em;
             }
        }

    </style>
</head>
<body>

    <h1>ğŸ§­ Ù†Ø§ÙˆØ¨Ø± Ø¢Ø´ÙˆØ¨</h1>
    
    <button id="toggle-layout-btn">ØªØºÛŒÛŒØ± Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§Ø±Ú¯Ø§Ù†ÛŒÚ©</button>

    <div id="help-text">
        Ø±ÙˆÛŒ Ú¯Ø±Ù‡â€ŒÙ‡Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯...
    </div>

    <div id="visualization"></div>

    <div id="modal-backdrop" class="modal-backdrop"></div>
    <div id="custom-modal" class="glass-modal"> {/* Ø§ÙØ²ÙˆØ¯Ù† Ú©Ù„Ø§Ø³ Ù¾Ø§ÛŒÙ‡ */}
        <div id="modal-header">...</div>
        <div id="modal-body">
            
            <div id="choice-buttons">
                    <p>Ú†Ù‡ Ú©Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯ØŸ</p>
                    <button id="choice-add-btn">â• Ø§ÙØ²ÙˆØ¯Ù† Ø§Ù†Ø´Ø¹Ø§Ø¨ Ø¬Ø¯ÛŒØ¯</button>
                    <button id="choice-edit-btn">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ / Ù‡Ø±Ø³ / Ø­Ø°Ù</button>
            </div>

            <form id="node-form">
                <div class="form-group">
                    <label for="node-title">Ø¹Ù†ÙˆØ§Ù†:</label>
                    <input type="text" id="node-title" placeholder="Ù…Ø«Ø§Ù„: Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡ X">
                </div>
                <div class="form-group">
                    <label for="node-desc">ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
                    <textarea id="node-desc" placeholder="Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ± Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø§ÛŒÙ† Ø§Ø­ØªÙ…Ø§Ù„..."></textarea>
                </div>
                <div class="form-group">
                    <label for="node-action">Ø§Ù‚Ø¯Ø§Ù…:</label>
                    <textarea id="node-action" placeholder="Ø§Ú¯Ø± Ø§ÛŒÙ† Ø§ØªÙØ§Ù‚ Ø§ÙØªØ§Ø¯ Ú†Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ"></textarea>
                </div>
                <div class="form-group">
                    <label for="node-probability">Ø§Ø­ØªÙ…Ø§Ù„ (0-10):</label>
                    <input type="range" id="node-probability" min="0" max="10" value="5">
                    <small>Ø§Ù…ØªÛŒØ§Ø² Ø¨ÛŒÙ† 0 ØªØ§ 10 Ø¨Ø¯Ù‡ÛŒØ¯.</small>
                </div>
                <div class="form-group">
                    <label for="node-anxiety">Ø§Ø¶Ø·Ø±Ø§Ø¨ (0-100):</label>
                    <input type="range" id="node-anxiety" min="0" max="100" value="50">
                    <small>Ù…ÛŒØ²Ø§Ù† Ù†Ú¯Ø±Ø§Ù†ÛŒ Ø§Ø² ÙˆÙ‚ÙˆØ¹ (0 Ú©Ù…ØŒ 100 Ø²ÛŒØ§Ø¯)</small> 
                </div>
                <div class="form-group">
                    <label for="node-dueDate">ØªØ§Ø±ÛŒØ® Ú©Ù„ÛŒØ¯ÛŒ:</label>
                    <input type="date" id="node-dueDate" placeholder="ØªØ§Ø±ÛŒØ®ÛŒ Ú©Ù‡ Ù†ØªÛŒØ¬Ù‡ Ù…Ø´Ø®Øµ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
                </div>
            </form>

        </div>
        <div id="modal-footer">
            <div id="action-buttons"><button id="happened-btn">âœ…</button><button id="not-happened-btn">âŒ</button><button id="delete-btn">ğŸ—‘ï¸</button></div>
            </div>
    </div>

    <div id="welcome-modal-backdrop" class="modal-backdrop"></div>
    <div id="welcome-modal" class="glass-modal"> {/* Ø§ÙØ²ÙˆØ¯Ù† Ú©Ù„Ø§Ø³ Ù¾Ø§ÛŒÙ‡ */}
        <h2>ğŸ§­ Ø¨Ù‡ Ù†Ø§ÙˆØ¨Ø± Ø¢Ø´ÙˆØ¨ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
        
        <input type="text" id="welcome-new-map-name" placeholder="Ù†Ø§Ù… Ù†Ù‚Ø´Ù‡ Ø¬Ø¯ÛŒØ¯...">
        <div id="welcome-load-section">
            <label for="welcome-map-selector">ÛŒÚ© Ù†Ù‚Ø´Ù‡ Ù‚Ø¨Ù„ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</label>
            <select id="welcome-map-selector"></select>
            </div>
    </div>

    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <script type="text/javascript">
        
        // --- Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ØªÙ„Ú¯Ø±Ø§Ù… ---
        const tg = window.Telegram.WebApp;
        
        // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---
        function getNodeSizeProps(probability) {
            const prob = Math.max(parseFloat(probability) || 0, 0);
            const size = 15 + prob; 
            return {
                size: size,
                widthConstraint: size * 2,
                heightConstraint: size * 2
            };
        }

        // --- Ø§Ù„Ù: ØªØ¹Ø±ÛŒÙ Ø¯ÛŒØªØ§Ø¨ÛŒØ³â€ŒÙ‡Ø§ ---
        var nodes = new vis.DataSet();
        var edges = new vis.DataSet();
        var data = { nodes: nodes, edges: edges };
        var nodeDataStore = {};

        let allMapsData = {}; 
        let currentMapId = null;
        const defaultMapId = 'map_default';

        const rootId = 1;
        const rootData = { 
            id: rootId, 
            title: 'Ù…ÙˆØ¶ÙˆØ¹ Ø§ØµÙ„ÛŒ', 
            description: 'Ø±ÙˆÛŒ Ù…Ù† Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯...', 
            actionPlan: '', 
            probability: 10, 
            cumulativeProbability: 10, 
            anxiety: 0, 
            dueDate: '', 
            pruned: false, 
        };
        nodeDataStore[rootId] = rootData;
        
        nodes.add({ 
            id: rootId, 
            label: rootData.title, 
            shape: 'circle', 
            ...getNodeSizeProps(rootData.cumulativeProbability), 
            color: { background: '#4fc3f7', border: '#81d4fa' }, 
            font: { color: 'white', size: 14, multi: false } 
        });
        
        const prunedColor = { background: '#1e293b', border: '#334155', highlight: { background: '#1e293b', border: '#334155' } };
        const prunedFont = { color: '#475569' };

        // --- Ø¨ØŒ Ø¬ØŒ Ø¯: ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø±Ø§Ù ---
        const baseOptions = { 
            nodes: { 
                shape: 'circle', 
                ...getNodeSizeProps(5), 
                scaling: { label: { enabled: false } }, 
                color: { 
                    background: '#334155', 
                    border: '#475569', 
                    highlight: { background: '#475569', border: '#4fc3f7' } 
                }, 
                font: { color: '#e0f2fe', size: 14, multi: false }, 
            }, 
            interaction: { dragNodes: true, dragView: true, zoomView: true } 
        };
        const hierarchicalOptions = { /* ... */ }; // (Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
        const physicsOptions = { /* ... */ }; // (Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
        
        var container = document.getElementById('visualization');
        let isHierarchical = true;
        var network = new vis.Network(container, data, hierarchicalOptions);
        const toggleBtn = document.getElementById('toggle-layout-btn');
        toggleBtn.addEventListener('click', function() { /* ... */ }); // (Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)

        // --- Ù‡Ù€: Ù…Ù†Ø·Ù‚ Ù¾Ø§Ù¾â€ŒØ¢Ù¾ (Modal) ---
        
        const modal = document.getElementById('custom-modal');
        const backdrop = document.getElementById('modal-backdrop');
        const modalHeader = document.getElementById('modal-header');
        const nodeForm = document.getElementById('node-form');
        const titleInput = document.getElementById('node-title');
        const descInput = document.getElementById('node-desc');
        const actionInput = document.getElementById('node-action');
        const probabilityInput = document.getElementById('node-probability');
        const anxietyInput = document.getElementById('node-anxiety');
        const dueDateInput = document.getElementById('node-dueDate');
        // const saveBtn = document.getElementById('modal-save-btn'); // Ø­Ø°Ù Ø´Ø¯
        // const closeBtn = document.getElementById('modal-close-btn'); // Ø­Ø°Ù Ø´Ø¯
        const actionButtons = document.getElementById('action-buttons'); 
        const happenedBtn = document.getElementById('happened-btn');
        const notHappenedBtn = document.getElementById('not-happened-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const choiceButtonsDiv = document.getElementById('choice-buttons');
        const choiceAddBtn = document.getElementById('choice-add-btn');
        const choiceEditBtn = document.getElementById('choice-edit-btn');
        
        let currentMode = 'choice'; // "choice", "add", "edit"
        let selectedNodeId = null; 
        let currentModal = null; // "welcome" or "custom" or null

        // --- ØªÙˆØ§Ø¨Ø¹ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù…ÙˆØ¯Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´/Ø§ÙØ²ÙˆØ¯Ù† ---
        
        // ØªØºÛŒÛŒØ± Û³: ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù‡Ù†Ø¯Ù„ Ú©Ø±Ø¯Ù† Ú©Ù„ÛŒÚ© MainButton
        function handleCustomModalSave() {
             tg.MainButton.showProgress(); // Ù†Ù…Ø§ÛŒØ´ Ù„ÙˆØ¯ÛŒÙ†Ú¯
             
             const localProb = parseFloat(probabilityInput.value) || 0;
            
            let parentNodeData = null;
            if (currentMode === 'add') {
                 parentNodeData = nodeDataStore[selectedNodeId];
            } else if (currentMode === 'edit' && selectedNodeId !== rootId) {
                const parentEdge = edges.get({ filter: e => e.to === selectedNodeId });
                if (parentEdge.length > 0) {
                    parentNodeData = nodeDataStore[parentEdge[0].from];
                }
            }
            const parentCumProb = parentNodeData ? parentNodeData.cumulativeProbability : 10;
            
            const newCumulativeProb = (selectedNodeId === rootId && currentMode === 'edit') 
                ? localProb 
                : parentCumProb * (localProb / 10.0);

            const nodeData = {
                title: titleInput.value.trim() || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†',
                description: descInput.value.trim(),
                actionPlan: actionInput.value.trim(),
                probability: localProb, 
                cumulativeProbability: newCumulativeProb, 
                anxiety: anxietyInput.value,
                dueDate: dueDateInput.value,
                pruned: false,
            };
            
            const displayData = { 
                label: nodeData.title,
                ...getNodeSizeProps(nodeData.cumulativeProbability)
            }; 

            try {
                if (currentMode === 'add') {
                    const newNodeId = Date.now();
                    nodeDataStore[newNodeId] = { id: newNodeId, ...nodeData };
                    nodes.add({ id: newNodeId, ...displayData });
                    edges.add({ from: selectedNodeId, to: newNodeId });
                } else if (currentMode === 'edit') {
                    nodeDataStore[selectedNodeId] = { ...nodeDataStore[selectedNodeId], ...nodeData, id: selectedNodeId };
                    nodes.update({ id: selectedNodeId, ...displayData });
                    updateChildrenCumulativeProb(selectedNodeId);
                }
                saveCurrentMapData(); 
                tg.HapticFeedback.notificationOccurred('success'); // Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ù…ÙˆÙÙ‚ÛŒØª
                closeModal(); // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ù¾Ø³ Ø§Ø² Ù…ÙˆÙÙ‚ÛŒØª
            } catch (err) { 
                console.error("Save error:", err);
                tg.showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø³Ø§Ø²ÛŒ Ú¯Ø±Ù‡: ' + err.message); 
                tg.HapticFeedback.notificationOccurred('error'); // Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ø®Ø·Ø§
            } finally {
                 tg.MainButton.hideProgress(); // Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ù„ÙˆØ¯ÛŒÙ†Ú¯
            }
        }

        function openModal(mode, nodeId) {
            currentModal = "custom"; // Ù…Ø´Ø®Øµ Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ ÙØ¹Ø§Ù„
            currentMode = mode;
            selectedNodeId = nodeId;
            
            choiceButtonsDiv.style.display = 'none';
            nodeForm.style.display = 'none';
            actionButtons.style.display = 'none';
            // MainButton Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† saveBtn Ù…ÛŒâ€ŒØ´ÙˆØ¯
            tg.MainButton.hide(); 
            // Ù†Ù…Ø§ÛŒØ´ BackButton Ø¨Ø±Ø§ÛŒ Ø¨Ø³ØªÙ†
            tg.BackButton.show();
            tg.onEvent('backButtonClicked', closeModal);

            if (mode === 'choice') {
                modalHeader.innerText = `Ú¯Ø±Ù‡: ${nodeDataStore[nodeId]?.title || 'Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'}`;
                choiceButtonsDiv.style.display = 'block';
                 // Ø¯Ø± Ø­Ø§Ù„Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ Ùˆ Ø¨Ú© Ù†Ø¯Ø§Ø±ÛŒÙ…
                 tg.BackButton.hide();
            } else if (mode === 'add') {
                modalHeader.innerText = 'Ø§ÙØ²ÙˆØ¯Ù† Ø§Ù†Ø´Ø¹Ø§Ø¨ Ø¬Ø¯ÛŒØ¯';
                nodeForm.reset();
                Array.from(nodeForm.elements).forEach(el => el.disabled = false);
                probabilityInput.value = 5; 
                anxietyInput.value = 50;
                nodeForm.style.display = 'block';
                // ØªÙ†Ø¸ÛŒÙ… Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù†
                tg.MainButton.setText('Ø§ÙØ²ÙˆØ¯Ù† Ú¯Ø±Ù‡');
                tg.MainButton.onClick(handleCustomModalSave);
                tg.MainButton.show();
                
            } else if (mode === 'edit') {
                modalHeader.innerText = 'ÙˆÛŒØ±Ø§ÛŒØ´ / Ù‡Ø±Ø³ / Ø­Ø°Ù';
                nodeForm.style.display = 'block';
                
                const nodeData = nodeDataStore[nodeId];
                if (!nodeData) return closeModal();

                titleInput.value = nodeData.title;
                descInput.value = nodeData.description || '';
                actionInput.value = nodeData.actionPlan || '';
                probabilityInput.value = nodeData.probability || 5; 
                anxietyInput.value = nodeData.anxiety || 50;
                dueDateInput.value = nodeData.dueDate || '';

                // Ù†Ù…Ø§ÛŒØ´/Ø¹Ø¯Ù… Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ú©Ø´Ù† (âœ… âŒ ğŸ—‘ï¸)
                if (nodeId !== rootId && !nodeData.pruned) { 
                    actionButtons.style.display = 'flex';
                }
                
                // Ø§Ú¯Ø± Ù‡Ø±Ø³ Ø´Ø¯Ù‡ØŒ ÙØ±Ù… Ù‚ÙÙ„ Ùˆ Ø¯Ú©Ù…Ù‡ Ø°Ø®ÛŒØ±Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… ØºÛŒØ±ÙØ¹Ø§Ù„
                if (nodeData.pruned) {
                    Array.from(nodeForm.elements).forEach(el => el.disabled = true);
                     tg.BackButton.show(); // ÙÙ‚Ø· Ø¯Ú©Ù…Ù‡ Ø¨Ø±Ú¯Ø´Øª
                } else {
                    // ØªÙ†Ø¸ÛŒÙ… Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
                    tg.MainButton.setText('Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª');
                    tg.MainButton.onClick(handleCustomModalSave);
                    tg.MainButton.show();
                }
            }
            
            modal.style.display = 'flex'; 
            backdrop.style.display = 'block';
        }

        function closeModal() {
             if (currentModal === "custom") {
                 modal.style.display = 'none';
                 backdrop.style.display = 'none';
                 selectedNodeId = null;
                 // Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… Ùˆ Ø­Ø°Ù Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§
                 tg.MainButton.offClick(handleCustomModalSave); // Ø­Ø°Ù Ù‡Ù†Ø¯Ù„Ø± Ù‚Ø¨Ù„ÛŒ
                 tg.MainButton.hide();
                 tg.BackButton.offClick(closeModal);
                 tg.BackButton.hide();
                 currentModal = null;
             } else if (currentModal === "welcome") {
                 // Ù…Ù†Ø·Ù‚ Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ (Ø§Ú¯Ø± Ù„Ø§Ø²Ù… Ø¨Ø§Ø´Ø¯ Ø¯Ú©Ù…Ù‡ Ø¨Ø³ØªÙ† Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯)
                 // ÙØ¹Ù„Ø§ ÙÙ‚Ø· Ø¨Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø³ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
             }
        }
        
        // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ Ù…ÙˆØ¯Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´/Ø§ÙØ²ÙˆØ¯Ù†
        choiceAddBtn.onclick = function() {
            openModal('add', selectedNodeId); 
        };
        choiceEditBtn.onclick = function() {
            openModal('edit', selectedNodeId);
        };
        
        // --- Ùˆ: Ù…Ù†Ø·Ù‚ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ú¯Ø±Ù‡ ---
        network.on('click', function(params) {
             // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ø§Ø² Ø´Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ù‡Ù†Ú¯Ø§Ù… Ø¯Ø±Ú¯ Ú©Ø±Ø¯Ù†
             network.on("dragStart", () => { network.off('click'); });
             network.on("dragEnd", () => { 
                 // Ú©Ù…ÛŒ ØªØ§Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ù„ÛŒÚ© Ù†Ø§Ø®ÙˆØ§Ø³ØªÙ‡ Ù¾Ø³ Ø§Ø² Ø¯Ø±Ú¯
                 setTimeout(() => network.on('click', nodeClickHandler), 100); 
             });

             // Ù‡Ù†Ø¯Ù„Ø± Ø§ØµÙ„ÛŒ Ú©Ù„ÛŒÚ©
             const nodeClickHandler = (clickParams) => {
                 if (clickParams.nodes.length > 0) {
                     const nodeId = clickParams.nodes[0];
                     openModal('choice', nodeId); 
                     tg.HapticFeedback.impactOccurred('light'); // Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ù„Ù…Ø³ÛŒ
                 }
             };
             // Ø§ØªØµØ§Ù„ Ø§ÙˆÙ„ÛŒÙ‡ Ù‡Ù†Ø¯Ù„Ø±
             network.off('click', nodeClickHandler); // Ø­Ø°Ù Ù‚Ø¨Ù„ÛŒ (Ø§Ú¯Ø± Ø¨ÙˆØ¯)
             network.on('click', nodeClickHandler);
             // Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ú©Ù„ÛŒÚ© ÙØ¹Ù„ÛŒ
             nodeClickHandler(params); 
         });
         
        // --- ØªØ§Ø¨Ø¹ Ø¢Ù¾Ø¯ÛŒØª Ø¨Ø§Ø²Ú¯Ø´ØªÛŒ ÙØ±Ø²Ù†Ø¯Ø§Ù† ---
        function updateChildrenCumulativeProb(parentNodeId) { /* ... */ } // (Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)

        
        // --- Ø²: Ù…Ù†Ø·Ù‚ Ù‡Ø±Ø³ Ú©Ø±Ø¯Ù† Ùˆ Ø§Ø±ØªÙ‚Ø§Ø¡ ---
        
        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² showConfirm ØªÙ„Ú¯Ø±Ø§Ù…
        happenedBtn.onclick = function() { 
             tg.showConfirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ú¯Ø±Ù‡ Ø¨Ù‡ Ø±ÛŒØ´Ù‡ Ø¬Ø¯ÛŒØ¯ ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯Ù‡ Ùˆ Ø¨Ù‚ÛŒÙ‡ Ø§Ù†Ø´Ø¹Ø§Ø¨Ø§Øª Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.", (ok) => {
                 if (ok) {
                    promoteNodeToRoot(selectedNodeId); 
                    saveCurrentMapData(); 
                    tg.HapticFeedback.notificationOccurred('success');
                    closeModal(); 
                 }
             });
        };
        
        notHappenedBtn.onclick = function() { 
            // Ø¨Ø±Ø§ÛŒ Ù‡Ø±Ø³ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ ØªØ§ÛŒÛŒØ¯ Ù†ÛŒØ³Øª Ú†ÙˆÙ† Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª (ÙØ¹Ù„Ø§)
            pruneSiblings(selectedNodeId, false); 
            saveCurrentMapData(); 
            tg.HapticFeedback.notificationOccurred('warning'); // ÛŒØ§ success
            closeModal(); 
        };

        deleteBtn.onclick = function() { 
             tg.showConfirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú¯Ø±Ù‡ Ùˆ ØªÙ…Ø§Ù… Ø²ÛŒØ±Ø´Ø§Ø®Ù‡â€ŒÙ‡Ø§ÛŒØ´ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ (ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª)", (ok) => {
                 if (ok) {
                     deleteNodeAndChildren(selectedNodeId); 
                     saveCurrentMapData(); 
                     tg.HapticFeedback.notificationOccurred('success');
                     closeModal(); 
                 }
             });
        };

        // ØªÙˆØ§Ø¨Ø¹ pruneSiblings, pruneNodeAndChildren, getDescendants, promoteNodeToRoot Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±

        // --- Ø­: Ù…Ù†Ø·Ù‚ Ø­Ø°Ù ---
        function deleteNodeAndChildren(startNodeId) { /* ... */ } // (Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)

        // --- Ø·: Ù…Ù†Ø·Ù‚ Ø°Ø®ÛŒØ±Ù‡ Ø³Ø§Ø²ÛŒ Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ---
        const localStorageKey = 'chaosMapMultiData_v2_tg'; // Ú©Ù„ÛŒØ¯ Ù…ØªÙØ§ÙˆØª Ø¨Ø±Ø§ÛŒ Ù…ÛŒÙ†ÛŒ Ø§Ù¾
        const lastActiveMapKey = 'chaosMapLastActive_v2_tg';
        // const visitedKey = 'chaosNavigatorVisited_v1_tg'; // Ø¯ÛŒÚ¯Ø± Ù„Ø§Ø²Ù… Ù†ÛŒØ³Øª

        function saveAllData() { /* ... */ } // (Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
        function saveCurrentMapData() { /* ... */ } // (Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
        
        function showMainUI() {
            document.getElementById('visualization').style.display = 'block';
            document.querySelector('h1').style.display = 'block';
            document.getElementById('toggle-layout-btn').style.display = 'block';
            document.getElementById('help-text').style.display = 'block';
            // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¨Ø³ØªÙ‡ Ø¨ÙˆØ¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ
            closeWelcomeModal(); 
             // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¨Ø³ØªÙ† Ø¨Ø§ Ø³ÙˆØ§ÛŒÙ¾ (Ø§Ú¯Ø± Ù„Ø§Ø²Ù… Ø¨Ø§Ø´Ø¯)
             tg.enableClosingConfirmation(); 
        }
        
        function loadMap(mapId) { 
             // ... (Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ù‚Ø´Ù‡ Ù…Ø«Ù„ Ù‚Ø¨Ù„) ...
             
            showMainUI();

            setTimeout(() => {
                if (!isHierarchical) {
                    nodes.update({ id: rootId, fixed: true, x: 0, y: 0 }); 
                }
                try { // ÙÙˆÚ©ÙˆØ³ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù‚Ø¨Ù„ Ø§Ø² Ø±Ù†Ø¯Ø± Ú©Ø§Ù…Ù„ Ø®Ø·Ø§ Ø¯Ù‡Ø¯
                     network.focus(rootId, {
                        scale: 1.0, 
                        animation: { duration: 800, easingFunction: 'easeInOutQuad' }
                     });
                } catch (e) { console.warn("Focus error ignored:", e); }
            }, 50); // Ú©Ù…ÛŒ ØªØ§Ø®ÛŒØ± Ø¨ÛŒØ´ØªØ± Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù†
        }
        
        // ØªØºÛŒÛŒØ± Û´: createNewMap Ù†Ø§Ù… Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù† Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯
        function createNewMap(isDefault = false, mapNameFromInput = null) { 
            let mapName = mapNameFromInput; 
            if (isDefault) {
                mapName = "Ù†Ù‚Ø´Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶";
            } else if (!mapName) { 
                 // Ø§Ú¯Ø± Ù†Ø§Ù… Ø§Ø² ÙˆØ±ÙˆØ¯ÛŒ Ù†ÛŒØ§Ù…Ø¯Ù‡ØŒ ÛŒÚ© Ù†Ø§Ù… Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø¯Ù‡
                 mapName = `Ù†Ù‚Ø´Ù‡ ${Object.keys(allMapsData).length + 1}`;
            }
            
            const newMapId = isDefault ? defaultMapId : `map_${Date.now()}`; 
            const defaultNodeData = { ...rootData }; 
            allMapsData[newMapId] = { id: newMapId, name: mapName, nodes: [{ id: rootId, label: defaultNodeData.title }], edges: [], nodeStore: { [rootId]: defaultNodeData } }; 
            loadMap(newMapId); 
            saveAllData(); 
            return newMapId; // Ø¢ÛŒØ¯ÛŒ Ù†Ù‚Ø´Ù‡ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
        }
        function deleteCurrentMap() { /* ... */ } // (Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
        function updateMapSelector() { /* ... */ } // (Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
        
        // --- ÛŒ: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---
        
        const welcomeModal = document.getElementById('welcome-modal');
        const welcomeBackdrop = document.getElementById('welcome-modal-backdrop');
        const welcomeMapSelector = document.getElementById('welcome-map-selector');
        const welcomeLoadSection = document.getElementById('welcome-load-section');
        const welcomeNewMapNameInput = document.getElementById('welcome-new-map-name'); 

        // Ø­Ø°Ù Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡ Ù…ÙˆØ¯Ø§Ù„ Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø²Ø¯ÛŒØ¯
        
        function populateWelcomeSelector() { /* ... */ } // (Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)

        function closeWelcomeModal() {
            welcomeModal.style.display = 'none';
            welcomeBackdrop.style.display = 'none';
            // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…
            tg.MainButton.offClick(handleWelcomeCreate);
            tg.MainButton.offClick(handleWelcomeLoad);
            tg.MainButton.hide();
            currentModal = null;
        }

         // ØªØºÛŒÛŒØ± Ûµ: Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„ Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ
         function handleWelcomeCreate() {
             const newName = welcomeNewMapNameInput.value.trim();
             if (!newName) {
                 tg.showAlert("Ù„Ø·ÙØ§ ÛŒÚ© Ù†Ø§Ù… Ø¨Ø±Ø§ÛŒ Ù†Ù‚Ø´Ù‡ Ø¬Ø¯ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
                 welcomeNewMapNameInput.focus();
                 return;
             }
             tg.MainButton.showProgress();
             // Ú©Ù…ÛŒ ØªØ§Ø®ÛŒØ± ØªØ§ Ú©Ø§Ø±Ø¨Ø± Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ø±Ø§ Ø¨Ø¨ÛŒÙ†Ø¯
             setTimeout(() => {
                 const newMapId = createNewMap(false, newName); 
                 if (newMapId) { 
                     closeWelcomeModal(); // loadMap Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ UI Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯
                 } else {
                     tg.showAlert("Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù‚Ø´Ù‡ Ø¬Ø¯ÛŒØ¯.");
                 }
                  tg.MainButton.hideProgress();
             }, 100);
         }

         function handleWelcomeLoad() {
             const selectedMapId = welcomeMapSelector.value;
             if (selectedMapId) {
                 tg.MainButton.showProgress();
                 setTimeout(() => {
                    loadMap(selectedMapId);
                    closeWelcomeModal();
                    tg.MainButton.hideProgress();
                 }, 100);
             } else {
                 tg.showAlert("Ù†Ù‚Ø´Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª."); 
             }
         }


        function initialLoad() { 
            currentModal = "welcome"; // Ù…Ø´Ø®Øµ Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ ÙØ¹Ø§Ù„
            
            const savedDataString = localStorage.getItem(localStorageKey); 
            if (savedDataString) { 
                try { allMapsData = JSON.parse(savedDataString); } catch (error) { allMapsData = {}; } 
            } else { 
                allMapsData = {}; 
            } 
            
            populateWelcomeSelector();
            
            // ØªÙ†Ø¸ÛŒÙ… Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ¬ÙˆØ¯ Ù†Ù‚Ø´Ù‡â€ŒÙ‡Ø§
             if (Object.keys(allMapsData).length > 0) {
                 // Ø§Ú¯Ø± Ù†Ù‚Ø´Ù‡ Ù‡Ø³ØªØŒ Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø³Øª
                 welcomeMapSelector.focus(); // ÙÙˆÚ©ÙˆØ³ Ø±ÙˆÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù‚Ø´Ù‡
                 tg.MainButton.setText("Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ù‚Ø´Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡");
                 tg.MainButton.onClick(handleWelcomeLoad);
             } else {
                 // Ø§Ú¯Ø± Ù†Ù‚Ø´Ù‡â€ŒØ§ÛŒ Ù†ÛŒØ³ØªØŒ ÙÙ‚Ø· Ú¯Ø²ÛŒÙ†Ù‡ Ø§ÛŒØ¬Ø§Ø¯ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
                 welcomeNewMapNameInput.focus(); // ÙÙˆÚ©ÙˆØ³ Ø±ÙˆÛŒ Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯
                 tg.MainButton.setText("Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù‚Ø´Ù‡ Ø¬Ø¯ÛŒØ¯");
                 tg.MainButton.onClick(handleWelcomeCreate);
             }
             tg.MainButton.show();


            welcomeModal.style.display = 'block';
            welcomeBackdrop.style.display = 'block';

             // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¨Ø³ØªÙ† Ø¨Ø§ Ø³ÙˆØ§ÛŒÙ¾ Ø¯Ø± ØµÙØ­Ù‡ Ø§ÙˆÙ„
             tg.disableClosingConfirmation(); 
        }
        
        // --- Ú©: Ø§ØªØµØ§Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± ---
        // (Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¯Ø± Ù…ÛŒÙ†ÛŒ Ø§Ù¾ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ Ù†Ø¯Ø§Ø±Ø¯ Ù…Ú¯Ø± Ø§ÛŒÙ†Ú©Ù‡ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø´Ø§Ø¨Ù‡ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯)

        // --- Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ ---
        tg.ready(() => {
             // tg.expand(); // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ØµÙØ­Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
             
            // Ø§Ø¹Ù…Ø§Ù„ ØªÙ… ØªÙ„Ú¯Ø±Ø§Ù… (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
            // document.body.style.backgroundColor = tg.themeParams.bg_color || '#0f172a';
            // document.body.style.color = tg.themeParams.text_color || '#e0f2fe';
            
            initialLoad();
        });

    </script>

</body>
</html>